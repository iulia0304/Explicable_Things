'Summary: Download Data -> Add your formuals -> Organize -> Automate everything in a minute with VBA :)

Option Explicit

Sub MDMcompare_&Split()

‘Find and Download File in MDM (activate Google Chrome with Selenium driver for VBA; also activate it in VBA-reference)

Dim IE As WebDriver
Dim InputUser As WebElement
Dim InputPsw As WebElement
Dim BTSelect As WebElement
Dim BT1 As WebElement
Dim TipExport As WebElement
   
Set IE = New Selenium.ChromeDriver
IE.Start ("Chrome")
IE.Get http://raportarip/*  ‘complete your url
IE.Wait (2000)

'Connect user

 Set InputUser = IE.FindElementById("user").SendKeys("user")
 Set InputPsw = IE.FindElementById("pass").SendKeys("psw")
 Set BTSelect = IE.FindElementByClass("buton")
 BTSelect.Click

'Redirect/Navigate in Site with Xpath
 
Set BT1 = IE.FindElementByXPath("//a[text()='Analiza']")
BT1.Click
Set BT1 = IE.FindElementByXPath("//a[@class='redirectare' and text()='Curbe']")
BT1.Click
IE.Wait (3000)

'Export
Set TipExport = IE.FindElementById("tip_exp").SendKeys("Ecran")
Set BT1 = IE.FindElementByXPath("//input[@type='button' and @id='export']")
BT1.Click
IE.Wait (25000)

Set BT1 = IE.FindElementByXPath("//a[text()='Rapoarte']")
BT1.Click
Set BT1 = IE.FindElementByXPath("//a[text()='Rapoarte EAZ']")
BT1.Click
Set BT1 = IE.FindElementByXPath("//a[contains(text(), 'user')]")
BT1.Click
IE.Wait (6000)
IE.Close

'Prepare Export.xlsx

Application.Calculation = xlManual
Application.DisplayAlerts = False
Application.CutCopyMode = False
Application.ScreenUpdating = True

‘Transform to number(for different keyboard language: "." to "," - the replace formula had some problems in my case)
Columns("P").Select
Selection.TextToColumns Destination:=Range("P1"), DataType:=xlDelimited, _ TextQualifier:=xlDoubleQuote, ConsecutiveDelimiter:=False, Tab:=True, Other:=True, OtherChar:=".", FieldInfo:=Array(Array(1, 1), Array(2, 9)), TrailingMinusNumbers:=True

‘Find and Open File in PC

Dim filename As String
Dim path As String
Dim str As String

‘Set up the name format available

str = Format(Now, "yyyymmdd")
path = "C:\Users\user\Downloads\"
filename = Dir(path & "MDM_ECRAN_000000_user_" & str & "*.*")
If filename <> VBA.Constants.vbNullString Then
'Do Until filename = ""
On Error Resume Next
Workbooks.Open (path & filename)
filename = Dir
'Loop
End If

‘Add formulas

Dim mdmname As String
mdmname = ActiveWorkbook.Name
Dim lastrow As Long
Dim lastrow2 As Long
Dim col As Long

Workbooks("export.XLSX").Activate
lastrow = Cells(Rows.Count, 1).End(xlUp).Row
    
'COUNT formula
Columns("G:G").Insert Shift:=xlToRight, CopyOrigin:=xlFormatFromLeftOrAbove
Range("G2").Select
Selection.FormulaR1C1 = "=COUNTIF(R2C6:R" & lastrow & "C6,RC[-1])"
Selection.AutoFill Destination:=Range("G2:G" & lastrow)
Calculate
DoEvents
Columns("G").Formula=Colums(“G”).Value
Range("G1") = "Count"

‘Vlook-up formula
col = ActiveWorkbook.Worksheets("Sheet1").Cells(1, Columns.Count).End(xlToLeft).Column + 1
ActiveWorkbook.Worksheets("Sheet1").Cells(1, col).Select

Selection.FormulaR1C1 = "=VLOOKUP(C[-12],[" & mdmname & "]Sheet1!C3:C10,8,0)"
Selection.AutoFill Destination:=Range("R1:R" & lastrow)
Calculate
DoEvents
Columns("R").Formula=Colums(“R”).Value
ActiveWorkbook.Worksheets("Sheet1").Range("R1") = "Curbs/NoCurbs"

‘Add workbooks according to criteria

ActiveWorkbook.Worksheets("Sheet1").Range("$A$1:$R$" & lastrow).AutoFilter Field:=18, Criteria1:="=#N/A", Operator:=xlAnd

Dim new As Workbook

new = Workbooks.Add
Workbooks("export.XLSX").Activate
lastrow2 = Cells(Rows.Count, 1).End(xlUp).Row
Range("$A$1:$R$" & lastrow2).Select
Selection.SpecialCells(xlCellTypeVisible).Copy
Windows("Book1").Activate
Range("A1").PasteSpecial xlPasteAllUsingSourceTheme
Range("R:R").Delete

ActiveWorkbook.SaveAs ThisWorkbook.path & "\NoCurbs.xlsx"
ActiveWorkbook.Close

ActiveSheet.Range("$A$1:$R$" & lastrow).AutoFilter Field:=18, Criteria1:="<>#N/A", Operator:=xlAnd

new = Workbooks.Add
Workbooks("export.XLSX").Activate
lastrow2 = Cells(Rows.Count, 1).End(xlUp).Row
Range("$A$1:$R$" & lastrow2).Select
Selection.SpecialCells(xlCellTypeVisible).Copy
Windows("Book2").Activate
Range("A1").PasteSpecial xlPasteAllUsingSourceTheme

ActiveWorkbook.SaveAs ThisWorkbook.path & "\Curbs.xlsx"
ActiveWorkbook.Close

'Percent difference formula
          Dim lastrow3 As Long
lastrow3 = Cells(Rows.Count, 1).End(xlUp).Row
Range("S2").Select
Selection.FormulaR1C1 = "=ABS(RC[-2]-RC[-1])/ABS(RC[-2])"
Selection.NumberFormat = "0%"
Selection.AutoFill Destination:=Range("S2:S" & lastrow3)
Calculate
DoEvents
Columns("S").Formula=Colums(“S”).Value
Range("S1") = "Dif%"

Application.DisplayAlerts = True
Application.CutCopyMode = True
Application.ScreenUpdating = True

ActiveWorkbook.Close False

End Sub
